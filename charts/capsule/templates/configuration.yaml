{{- if or (and $.Values.crds.exclusive $.Values.crds.createConfig) (not $.Values.crds.exclusive) }}
  {{- if $.Values.manager.options.createConfiguration }}
apiVersion: capsule.clastix.io/v1beta2
kind: CapsuleConfiguration
metadata:
  name: {{ .Values.manager.options.capsuleConfiguration }}
  namespace: {{ $.Release.Namespace }}
  labels:
  {{- include "capsule.labels" . | nindent 4 }}
  {{- with .Values.manager.options.labels }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
  annotations:
  {{- with (mergeOverwrite .Values.customAnnotations .Values.manager.options.annotations) }}
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  cacheInvalidation: {{ .Values.manager.options.cacheInvalidation }}
  rbac:
    {{- toYaml .Values.manager.options.rbac | nindent 4 }}
  impersonation:
    {{- toYaml .Values.manager.options.impersonation | nindent 4 }}
  admission:
    validating:
      name: "{{ include "capsule.fullname" . }}-dynamic"
      client:
        {{- include "capsule.webhooks.serviceConfig" $ | nindent 8 }}
      {{- if (include "admission.labels" $) }}
      labels:
        {{- include "admission.labels" $ | nindent 8 }}
      {{- end }}
      {{- if (include "admission.annotations" $) }}
      annotations:
        {{- include "admission.annotations" $ | nindent 8 }}
      {{- end }}
    mutating:
      name: "{{ include "capsule.fullname" . }}-dynamic"
      client:
        {{- include "capsule.webhooks.serviceConfig" $ | nindent 8 }}
      {{- if (include "admission.labels" $) }}
      labels:
        {{- include "admission.labels" $ | nindent 8 }}
      {{- end }}
      {{- if (include "admission.annotations" $) }}
      annotations:
        {{- include "admission.annotations" $ | nindent 8 }}
      {{- end }}
  administrators:
    {{- toYaml .Values.manager.options.administrators | nindent 4 }}
  users:
    {{- toYaml .Values.manager.options.users | nindent 4 }}
  enableTLSReconciler: {{ .Values.tls.enableController }}
  overrides:
    mutatingWebhookConfigurationName: {{ include "capsule.fullname" . }}-mutating-webhook-configuration
    TLSSecretName: {{ include "capsule.secretTlsName" . }}
    validatingWebhookConfigurationName: {{ include "capsule.fullname" . }}-validating-webhook-configuration
  forceTenantPrefix: {{ .Values.manager.options.forceTenantPrefix }}
  allowServiceAccountPromotion: {{ .Values.manager.options.allowServiceAccountPromotion }}
  userGroups:
    {{- toYaml .Values.manager.options.capsuleUserGroups  | nindent 4 }}
  userNames:
    {{- toYaml .Values.manager.options.userNames | nindent 4 }}
  ignoreUserWithGroups:
    {{- toYaml .Values.manager.options.ignoreUserWithGroups | nindent 4 }}
  protectedNamespaceRegex: {{ .Values.manager.options.protectedNamespaceRegex | quote }}
  {{- with .Values.manager.options.nodeMetadata }}
  nodeMetadata:
    {{- toYaml . | nindent 4 }}
  {{- end }}
{{- end }}
{{- end }}
