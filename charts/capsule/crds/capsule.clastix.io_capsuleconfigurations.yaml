---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.20.0
  name: capsuleconfigurations.capsule.clastix.io
spec:
  group: capsule.clastix.io
  names:
    kind: CapsuleConfiguration
    listKind: CapsuleConfigurationList
    plural: capsuleconfigurations
    singular: capsuleconfiguration
  scope: Cluster
  versions:
  - name: v1beta2
    schema:
      openAPIV3Schema:
        description: CapsuleConfiguration is the Schema for the Capsule configuration
          API.
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: CapsuleConfigurationSpec defines the Capsule configuration.
            properties:
              administrators:
                description: |-
                  Define entities which can act as Administrators in the capsule construct
                  These entities are automatically owners for all existing tenants. Meaning they can add namespaces to any tenant. However they must be specific by using the capsule label
                  for interacting with namespaces. Because if that label is not defined, it's assumed that namespace interaction was not targeted towards a tenant and will therefor
                  be ignored by capsule.
                items:
                  properties:
                    kind:
                      description: Kind of entity. Possible values are "User", "Group",
                        and "ServiceAccount"
                      enum:
                      - User
                      - Group
                      - ServiceAccount
                      type: string
                    name:
                      description: Name of the entity.
                      type: string
                  required:
                  - kind
                  - name
                  type: object
                type: array
              admission:
                description: Configuration for dynamic Validating and Mutating Admission
                  webhooks managed by Capsule.
                properties:
                  mutating:
                    description: Configure dynamic Mutating Admission for Capsule
                    properties:
                      annotations:
                        additionalProperties:
                          type: string
                        description: Annotations added to the Admission Webhook
                        type: object
                      client:
                        description: From the upstram struct
                        properties:
                          caBundle:
                            description: |-
                              `caBundle` is a PEM encoded CA bundle which will be used to validate the webhook's server certificate.
                              If unspecified, system trust roots on the apiserver are used.
                            format: byte
                            type: string
                          service:
                            description: |-
                              `service` is a reference to the service for this webhook. Either
                              `service` or `url` must be specified.

                              If the webhook is running within the cluster, then you should use `service`.
                            properties:
                              name:
                                description: |-
                                  `name` is the name of the service.
                                  Required
                                type: string
                              namespace:
                                description: |-
                                  `namespace` is the namespace of the service.
                                  Required
                                type: string
                              path:
                                description: |-
                                  `path` is an optional URL path which will be sent in any request to
                                  this service.
                                type: string
                              port:
                                description: |-
                                  If specified, the port on the service that hosting webhook.
                                  Default to 443 for backward compatibility.
                                  `port` should be a valid port number (1-65535, inclusive).
                                format: int32
                                type: integer
                            required:
                            - name
                            - namespace
                            type: object
                          url:
                            description: |-
                              `url` gives the location of the webhook, in standard URL form
                              (`scheme://host:port/path`). Exactly one of `url` or `service`
                              must be specified.

                              The `host` should not refer to a service running in the cluster; use
                              the `service` field instead. The host might be resolved via external
                              DNS in some apiservers (e.g., `kube-apiserver` cannot resolve
                              in-cluster DNS as that would be a layering violation). `host` may
                              also be an IP address.

                              Please note that using `localhost` or `127.0.0.1` as a `host` is
                              risky unless you take great care to run this webhook on all hosts
                              which run an apiserver which might need to make calls to this
                              webhook. Such installs are likely to be non-portable, i.e., not easy
                              to turn up in a new cluster.

                              The scheme must be "https"; the URL must begin with "https://".

                              A path is optional, and if present may be any string permissible in
                              a URL. You may use the path to pass an arbitrary string to the
                              webhook, for example, a cluster identifier.

                              Attempting to use a user or basic auth e.g. "user:password@" is not
                              allowed. Fragments ("#...") and query parameters ("?...") are not
                              allowed, either.
                            type: string
                        type: object
                      labels:
                        additionalProperties:
                          type: string
                        description: Labels added to the Admission Webhook
                        type: object
                      name:
                        description: Name the Admission Webhook
                        maxLength: 63
                        pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                        type: string
                    required:
                    - client
                    type: object
                  validating:
                    description: Configure dynamic Validating Admission for Capsule
                    properties:
                      annotations:
                        additionalProperties:
                          type: string
                        description: Annotations added to the Admission Webhook
                        type: object
                      client:
                        description: From the upstram struct
                        properties:
                          caBundle:
                            description: |-
                              `caBundle` is a PEM encoded CA bundle which will be used to validate the webhook's server certificate.
                              If unspecified, system trust roots on the apiserver are used.
                            format: byte
                            type: string
                          service:
                            description: |-
                              `service` is a reference to the service for this webhook. Either
                              `service` or `url` must be specified.

                              If the webhook is running within the cluster, then you should use `service`.
                            properties:
                              name:
                                description: |-
                                  `name` is the name of the service.
                                  Required
                                type: string
                              namespace:
                                description: |-
                                  `namespace` is the namespace of the service.
                                  Required
                                type: string
                              path:
                                description: |-
                                  `path` is an optional URL path which will be sent in any request to
                                  this service.
                                type: string
                              port:
                                description: |-
                                  If specified, the port on the service that hosting webhook.
                                  Default to 443 for backward compatibility.
                                  `port` should be a valid port number (1-65535, inclusive).
                                format: int32
                                type: integer
                            required:
                            - name
                            - namespace
                            type: object
                          url:
                            description: |-
                              `url` gives the location of the webhook, in standard URL form
                              (`scheme://host:port/path`). Exactly one of `url` or `service`
                              must be specified.

                              The `host` should not refer to a service running in the cluster; use
                              the `service` field instead. The host might be resolved via external
                              DNS in some apiservers (e.g., `kube-apiserver` cannot resolve
                              in-cluster DNS as that would be a layering violation). `host` may
                              also be an IP address.

                              Please note that using `localhost` or `127.0.0.1` as a `host` is
                              risky unless you take great care to run this webhook on all hosts
                              which run an apiserver which might need to make calls to this
                              webhook. Such installs are likely to be non-portable, i.e., not easy
                              to turn up in a new cluster.

                              The scheme must be "https"; the URL must begin with "https://".

                              A path is optional, and if present may be any string permissible in
                              a URL. You may use the path to pass an arbitrary string to the
                              webhook, for example, a cluster identifier.

                              Attempting to use a user or basic auth e.g. "user:password@" is not
                              allowed. Fragments ("#...") and query parameters ("?...") are not
                              allowed, either.
                            type: string
                        type: object
                      labels:
                        additionalProperties:
                          type: string
                        description: Labels added to the Admission Webhook
                        type: object
                      name:
                        description: Name the Admission Webhook
                        maxLength: 63
                        pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                        type: string
                    required:
                    - client
                    type: object
                type: object
              allowServiceAccountPromotion:
                default: false
                description: |-
                  ServiceAccounts within tenant namespaces can be promoted to owners of the given tenant
                  this can be achieved by labeling the serviceaccount and then they are considered owners. This can only be done by other owners of the tenant.
                  However ServiceAccounts which have been promoted to owner can not promote further serviceAccounts.
                type: boolean
              cacheInvalidation:
                default: 24h
                description: Define the period of time upon a cache invalidation is
                  executed for all caches.
                type: string
              enableTLSReconciler:
                default: false
                description: |-
                  Toggles the TLS reconciler, the controller that is able to generate CA and certificates for the webhooks
                  when not using an already provided CA and certificate, or when these are managed externally with Vault, or cert-manager.
                type: boolean
              forceTenantPrefix:
                default: false
                description: |-
                  Enforces the Tenant owner, during Namespace creation, to name it using the selected Tenant name as prefix,
                  separated by a dash. This is useful to avoid Namespace name collision in a public CaaS environment.
                type: boolean
              ignoreUserWithGroups:
                description: |-
                  Define groups which when found in the request of a user will be ignored by the Capsule
                  this might be useful if you have one group where all the users are in, but you want to separate administrators from normal users with additional groups.
                items:
                  type: string
                type: array
              impersonation:
                description: Service Account Client configuration for impersonation
                  properties
                properties:
                  caSecretKey:
                    default: ca.crt
                    description: Key in the secret that holds the CA certificate (e.g.,
                      "ca.crt")
                    type: string
                  caSecretName:
                    description: Name of the secret containing the CA certificate
                    maxLength: 63
                    pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                    type: string
                  caSecretNamespace:
                    description: Namespace where the CA certificate secret is located
                    maxLength: 253
                    pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                    type: string
                  endpoint:
                    description: Kubernetes API Endpoint to use for impersonation
                    type: string
                  globalDefaultServiceAccount:
                    description: |-
                      Default ServiceAccount for global resources (GlobalTenantResource)
                      When defined, users are required to use this ServiceAccount anywhere in the cluster
                      unless they explicitly provide their own.
                    maxLength: 63
                    pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                    type: string
                  globalDefaultServiceAccountNamespace:
                    description: |-
                      Default ServiceAccount for global resources (GlobalTenantResource)
                      When defined, users are required to use this ServiceAccount anywhere in the cluster
                      unless they explicitly provide their own.
                    maxLength: 253
                    pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?(\\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*$
                    type: string
                  skipTlsVerify:
                    default: false
                    description: If true, TLS certificate verification is skipped
                      (not recommended for production)
                    type: boolean
                  tenantDefaultServiceAccount:
                    description: |-
                      Default ServiceAccount for namespaced resources (TenantResource)
                      When defined, users are required to use this ServiceAccount within the namespace
                      where they deploy the resource, unless they explicitly provide their own.
                    maxLength: 63
                    pattern: ^[a-z0-9]([-a-z0-9]*[a-z0-9])?$
                    type: string
                type: object
              nodeMetadata:
                description: |-
                  Allows to set the forbidden metadata for the worker nodes that could be patched by a Tenant.
                  This applies only if the Tenant has an active NodeSelector, and the Owner have right to patch their nodes.
                properties:
                  forbiddenAnnotations:
                    description: Define the annotations that a Tenant Owner cannot
                      set for their nodes.
                    properties:
                      denied:
                        items:
                          type: string
                        type: array
                      deniedRegex:
                        type: string
                    type: object
                  forbiddenLabels:
                    description: Define the labels that a Tenant Owner cannot set
                      for their nodes.
                    properties:
                      denied:
                        items:
                          type: string
                        type: array
                      deniedRegex:
                        type: string
                    type: object
                type: object
              overrides:
                default:
                  TLSSecretName: capsule-tls
                  mutatingWebhookConfigurationName: capsule-mutating-webhook-configuration
                  validatingWebhookConfigurationName: capsule-validating-webhook-configuration
                description: |-
                  Allows to set different name rather than the canonical one for the Capsule configuration objects,
                  such as webhook secret or configurations.
                properties:
                  TLSSecretName:
                    default: capsule-tls
                    description: |-
                      Defines the Secret name used for the webhook server.
                      Must be in the same Namespace where the Capsule Deployment is deployed.
                    type: string
                  mutatingWebhookConfigurationName:
                    default: capsule-mutating-webhook-configuration
                    description: Name of the MutatingWebhookConfiguration which contains
                      the dynamic admission controller paths and resources.
                    type: string
                  validatingWebhookConfigurationName:
                    default: capsule-validating-webhook-configuration
                    description: Name of the ValidatingWebhookConfiguration which
                      contains the dynamic admission controller paths and resources.
                    type: string
                required:
                - TLSSecretName
                - mutatingWebhookConfigurationName
                - validatingWebhookConfigurationName
                type: object
              protectedNamespaceRegex:
                description: Disallow creation of namespaces, whose name matches this
                  regexp
                type: string
              rbac:
                default: {}
                description: Define Properties for managed ClusterRoles by Capsule
                properties:
                  administrationClusterRoles:
                    default:
                    - capsule-namespace-deleter
                    description: The ClusterRoles applied for Administrators
                    items:
                      type: string
                    type: array
                  deleter:
                    default: capsule-namespace-deleter
                    description: Name for the ClusterRole required to grant Namespace
                      Deletion permissions.
                    type: string
                  promotionClusterRoles:
                    default:
                    - capsule-namespace-provisioner
                    - capsule-namespace-deleter
                    description: The ClusterRoles applied for ServiceAccounts which
                      had owner Promotion
                    items:
                      type: string
                    type: array
                  provisioner:
                    default: capsule-namespace-provisioner
                    description: Name for the ClusterRole required to grant Namespace
                      Provision permissions.
                    type: string
                type: object
              userGroups:
                description: |-
                  Deprecated: use users property instead (https://projectcapsule.dev/docs/operating/setup/configuration/#users)

                  Names of the groups considered as Capsule users.
                items:
                  type: string
                type: array
              userNames:
                description: |-
                  Deprecated: use users property instead (https://projectcapsule.dev/docs/operating/setup/configuration/#users)

                  Names of the users considered as Capsule users.
                items:
                  type: string
                type: array
              users:
                description: |-
                  Define entities which are considered part of the Capsule construct
                  Users not mentioned here will be ignored by Capsule
                items:
                  properties:
                    kind:
                      description: Kind of entity. Possible values are "User", "Group",
                        and "ServiceAccount"
                      enum:
                      - User
                      - Group
                      - ServiceAccount
                      type: string
                    name:
                      description: Name of the entity.
                      type: string
                  required:
                  - kind
                  - name
                  type: object
                type: array
            required:
            - cacheInvalidation
            - enableTLSReconciler
            - rbac
            type: object
          status:
            description: CapsuleConfigurationStatus defines the Capsule configuration
              status.
            properties:
              lastCacheInvalidation:
                description: Last time all caches were invalided
                format: date-time
                type: string
              users:
                description: Users which are considered Capsule Users and are bound
                  to the Capsule Tenant construct.
                items:
                  properties:
                    kind:
                      description: Kind of entity. Possible values are "User", "Group",
                        and "ServiceAccount"
                      enum:
                      - User
                      - Group
                      - ServiceAccount
                      type: string
                    name:
                      description: Name of the entity.
                      type: string
                  required:
                  - kind
                  - name
                  type: object
                type: array
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
